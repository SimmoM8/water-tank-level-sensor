name: Release OTA Firmware

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 1.4.0 or v1.4.0)"
        required: true
        type: string
      sketch_dir:
        description: "Sketch directory"
        required: false
        default: "esp32/level_sensor"
        type: string
  push:
    tags:
      - "v*"

permissions:
  contents: write

concurrency:
  group: ota-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release-ota:
    runs-on: ubuntu-latest
    env:
      REPO_TOKEN: ${{ secrets.REPO_PUSH_TOKEN != '' && secrets.REPO_PUSH_TOKEN || github.token }}
      DEFAULT_SKETCH_DIR: esp32/level_sensor
      DEFAULT_BUILD_PROFILE: release
      MANIFEST_PATH: manifests/dev.json

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ env.REPO_TOKEN }}

      - name: Resolve release metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            RAW_VERSION="${{ inputs.version }}"
            SKETCH_DIR="${{ inputs.sketch_dir }}"
          else
            RAW_VERSION="${GITHUB_REF_NAME}"
            SKETCH_DIR="${DEFAULT_SKETCH_DIR}"
          fi

          VERSION="${RAW_VERSION#v}"
          TAG="v${VERSION}"
          ASSET_NAME="firmware-${VERSION}.bin"

          if [[ -z "${VERSION}" ]]; then
            echo "Resolved version is empty" >&2
            exit 1
          fi

          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "tag=${TAG}" >> "${GITHUB_OUTPUT}"
          echo "sketch_dir=${SKETCH_DIR}" >> "${GITHUB_OUTPUT}"
          echo "asset_name=${ASSET_NAME}" >> "${GITHUB_OUTPUT}"

      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      - name: Print Arduino CLI version
        shell: bash
        run: |
          set -euo pipefail
          arduino-cli version

      - name: Configure Arduino CLI boards manager URLs
        shell: bash
        run: |
          set -euo pipefail
          ESP32_URL="https://espressif.github.io/arduino-esp32/package_esp32_index.json"
          arduino-cli config init --overwrite
          arduino-cli config add board_manager.additional_urls "${ESP32_URL}"
          if ! arduino-cli config dump | grep -Fq "${ESP32_URL}"; then
            echo "::error::Failed to configure Arduino CLI with Espressif boards manager URL"
            exit 1
          fi

      - name: Refresh Arduino indexes
        shell: bash
        run: |
          set -euo pipefail
          arduino-cli core update-index
          arduino-cli lib update-index

      - name: Install pinned core + libraries from sketch.yaml
        id: deps
        shell: bash
        run: |
          set -euo pipefail

          SKETCH_FILE="${{ steps.meta.outputs.sketch_dir }}/sketch.yaml"
          PROFILE="${DEFAULT_BUILD_PROFILE}"

          if [[ ! -f "${SKETCH_FILE}" ]]; then
            echo "::error::Missing ${SKETCH_FILE}. Cannot install dependencies."
            exit 1
          fi

          mapfile -t DEP_LINES < <(awk -v profile="${PROFILE}" '
            $0 ~ "^  " profile ":" {in_profile=1; section=""; next}
            in_profile && $0 ~ "^  [^[:space:]][^:]*:" {in_profile=0; section=""; next}
            in_profile && $0 ~ "^    fqbn:" {
              v=$0
              sub("^    fqbn: ", "", v)
              print "FQBN|" v
            }
            in_profile && $0 ~ "^    platforms:" {section="platforms"; next}
            in_profile && $0 ~ "^    libraries:" {section="libraries"; next}
            in_profile && section=="platforms" && $0 ~ "^      - platform: " {
              v=$0
              sub("^      - platform: ", "", v)
              print "PLATFORM|" v
            }
            in_profile && section=="libraries" && $0 ~ "^      - " {
              v=$0
              sub("^      - ", "", v)
              print "LIB|" v
            }
          ' "${SKETCH_FILE}")

          if [[ ${#DEP_LINES[@]} -eq 0 ]]; then
            echo "::error::No dependencies found for profile '${PROFILE}' in ${SKETCH_FILE}."
            exit 1
          fi

          FQBN=""
          PLATFORM_COUNT=0
          LIB_COUNT=0
          ESP32_CORE_INSTALLED=0

          for line in "${DEP_LINES[@]}"; do
            kind="${line%%|*}"
            spec="${line#*|}"

            if [[ "${kind}" == "FQBN" ]]; then
              FQBN="${spec}"
              continue
            fi

            if [[ ! "${spec}" =~ ^(.+)\ \(([^)]+)\)$ ]]; then
              echo "::error::Dependency '${spec}' is not pinned as 'Name (version)'."
              exit 1
            fi

            name="${BASH_REMATCH[1]}"
            version="${BASH_REMATCH[2]}"

            if [[ "${kind}" == "PLATFORM" ]]; then
              PLATFORM_COUNT=$((PLATFORM_COUNT + 1))
              echo "Installing platform ${name}@${version}"
              if ! arduino-cli core install "${name}@${version}"; then
                echo "::error::Failed to install platform ${name}@${version}"
                exit 1
              fi
              if [[ "${name}" == "esp32:esp32" ]]; then
                ESP32_CORE_INSTALLED=1
              fi
            elif [[ "${kind}" == "LIB" ]]; then
              LIB_COUNT=$((LIB_COUNT + 1))
              echo "Installing library ${name}@${version} (primary)"
              if ! arduino-cli lib install "${name}@${version}"; then
                echo "Primary install failed for ${name}@${version}; retrying with name-only install"
                if ! arduino-cli lib install "${name}"; then
                  echo "::error::Failed to install library ${name} using both '${name}@${version}' and '${name}'"
                  exit 1
                fi
              fi

              lib_list="$(arduino-cli lib list)"

              # Match lines like:
              # WiFiManager          2.0.17   ...
              # (we anchor the name and grab the first version-looking token after it)
              actual_version="$(printf '%s\n' "${lib_list}" \
                | awk -v n="${name}" '
                    $0 ~ ("^" n "[[:space:]]+") {
                      if (match($0, /[[:space:]]+v?[0-9]+\.[0-9]+(\.[0-9]+)?([-.+][0-9A-Za-z.]+)?/, m)) {
                        v=m[0]
                        sub(/^[[:space:]]+/, "", v)
                        sub(/^v/, "", v)
                        print v
                        exit
                      }
                    }
                  ')"

              expected_version="${version#v}"

              if [[ -z "${actual_version}" ]]; then
                echo "::error::Library '${name}' appears uninstalled after install attempts; expected version ${expected_version}"
                exit 1
              fi

              if [[ "${actual_version}" != "${expected_version}" ]]; then
                echo "::error::Pinned library version mismatch for '${name}': expected ${expected_version}, got ${actual_version}"
                exit 1
              fi
            fi
          done

          if [[ -z "${FQBN}" ]]; then
            echo "::error::Missing fqbn for profile '${PROFILE}' in ${SKETCH_FILE}."
            exit 1
          fi
          if [[ ${PLATFORM_COUNT} -eq 0 ]]; then
            echo "::error::No platform dependencies found in ${SKETCH_FILE}."
            exit 1
          fi
          if [[ ${ESP32_CORE_INSTALLED} -ne 1 ]]; then
            echo "::error::Profile '${PROFILE}' does not declare required esp32:esp32 core."
            exit 1
          fi

          echo "Resolved FQBN: ${FQBN}"
          echo "Installed platform deps: ${PLATFORM_COUNT}"
          echo "Installed library deps: ${LIB_COUNT}"
          echo "fqbn=${FQBN}" >> "${GITHUB_OUTPUT}"

      - name: Print installed cores and libraries
        shell: bash
        run: |
          set -euo pipefail
          echo "Installed cores:"
          arduino-cli core list
          echo "Installed pinned libraries:"
          arduino-cli lib list | awk 'NR==1 || $0 ~ /^(WiFiManager|PubSubClient|ArduinoJson)[[:space:]]+/'

      - name: Ensure jq is available
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

      - name: Validate sketch inputs
        shell: bash
        run: |
          set -euo pipefail

          if [[ ! -f "${{ steps.meta.outputs.sketch_dir }}/level_sensor.ino" ]]; then
            echo "Sketch not found at ${{ steps.meta.outputs.sketch_dir }}/level_sensor.ino" >&2
            exit 1
          fi
          if [[ ! -f "${{ steps.meta.outputs.sketch_dir }}/sketch.yaml" ]]; then
            echo "Missing sketch.yaml at ${{ steps.meta.outputs.sketch_dir }} (dependency source-of-truth)" >&2
            exit 1
          fi

      - name: Dry-run compile (pinned profile)
        shell: bash
        run: |
          set -euo pipefail
          echo "Dry-run target FQBN: ${{ steps.deps.outputs.fqbn }}"
          arduino-cli compile --clean --fqbn "${{ steps.deps.outputs.fqbn }}" "${{ steps.meta.outputs.sketch_dir }}"

      - name: Compile firmware
        id: build
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p build
          arduino-cli compile \
            --fqbn "${{ steps.deps.outputs.fqbn }}" \
            --build-property "compiler.cpp.extra_flags=-DFW_VERSION=\\\"${{ steps.meta.outputs.version }}\\\"" \
            --output-dir build \
            "${{ steps.meta.outputs.sketch_dir }}"

          APP_BIN="build/level_sensor.ino.bin"
          if [[ ! -f "${APP_BIN}" ]]; then
            echo "Expected application binary not found at ${APP_BIN}" >&2
            echo "Build directory contents:" >&2
            ls -la build >&2 || true
            exit 1
          fi

          ASSET_PATH="build/${{ steps.meta.outputs.asset_name }}"
          cp "${APP_BIN}" "${ASSET_PATH}"
          SHA256="$(sha256sum "${ASSET_PATH}" | awk '{print $1}')"

          echo "firmware_path=${ASSET_PATH}" >> "${GITHUB_OUTPUT}"
          echo "sha256=${SHA256}" >> "${GITHUB_OUTPUT}"

      - name: Create GitHub Release and upload .bin
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ env.REPO_TOKEN }}
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.tag }}
          target_commitish: ${{ github.sha }}
          files: ${{ steps.build.outputs.firmware_path }}
          generate_release_notes: true

      - name: Update manifests/dev.json and push to main
        shell: bash
        run: |
          set -euo pipefail

          git fetch origin main
          git checkout main
          git pull --ff-only origin main

          mkdir -p "$(dirname "${MANIFEST_PATH}")"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.meta.outputs.tag }}/${{ steps.meta.outputs.asset_name }}"

          jq -n \
            --arg version "${{ steps.meta.outputs.version }}" \
            --arg url "${RELEASE_URL}" \
            --arg sha256 "${{ steps.build.outputs.sha256 }}" \
            '{version: $version, url: $url, sha256: $sha256}' > "${MANIFEST_PATH}"

          git add "${MANIFEST_PATH}"
          if git diff --cached --quiet; then
            echo "No manifest changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "chore(manifest): update dev.json for ${{ steps.meta.outputs.tag }} [skip ci]"
          git push origin HEAD:main
