name: Release OTA Firmware

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 1.4.0 or v1.4.0)"
        required: true
        type: string
      fqbn:
        description: "Arduino FQBN"
        required: false
        default: "esp32:esp32:esp32"
        type: string
      sketch_dir:
        description: "Sketch directory"
        required: false
        default: "esp32/level_sensor"
        type: string
  push:
    tags:
      - "v*"

permissions:
  contents: write

concurrency:
  group: ota-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release-ota:
    runs-on: ubuntu-latest
    env:
      REPO_TOKEN: ${{ secrets.REPO_PUSH_TOKEN != '' && secrets.REPO_PUSH_TOKEN || github.token }}
      DEFAULT_FQBN: esp32:esp32:esp32
      DEFAULT_SKETCH_DIR: esp32/level_sensor
      MANIFEST_PATH: manifests/dev.json

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ env.REPO_TOKEN }}

      - name: Resolve release metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            RAW_VERSION="${{ inputs.version }}"
            FQBN="${{ inputs.fqbn }}"
            SKETCH_DIR="${{ inputs.sketch_dir }}"
          else
            RAW_VERSION="${GITHUB_REF_NAME}"
            FQBN="${DEFAULT_FQBN}"
            SKETCH_DIR="${DEFAULT_SKETCH_DIR}"
          fi

          VERSION="${RAW_VERSION#v}"
          TAG="v${VERSION}"
          ASSET_NAME="firmware-${VERSION}.bin"

          if [[ -z "${VERSION}" ]]; then
            echo "Resolved version is empty" >&2
            exit 1
          fi

          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "tag=${TAG}" >> "${GITHUB_OUTPUT}"
          echo "fqbn=${FQBN}" >> "${GITHUB_OUTPUT}"
          echo "sketch_dir=${SKETCH_DIR}" >> "${GITHUB_OUTPUT}"
          echo "asset_name=${ASSET_NAME}" >> "${GITHUB_OUTPUT}"

      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      - name: Install ESP32 core
        shell: bash
        run: |
          set -euo pipefail
          arduino-cli core update-index
          arduino-cli core install esp32:esp32

      - name: Ensure jq is available
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

      - name: Compile firmware
        id: build
        shell: bash
        run: |
          set -euo pipefail

          if [[ ! -f "${{ steps.meta.outputs.sketch_dir }}/level_sensor.ino" ]]; then
            echo "Sketch not found at ${{ steps.meta.outputs.sketch_dir }}/level_sensor.ino" >&2
            exit 1
          fi

          mkdir -p build
          arduino-cli compile \
            --fqbn "${{ steps.meta.outputs.fqbn }}" \
            --build-property "compiler.cpp.extra_flags=-DFW_VERSION=\\\"${{ steps.meta.outputs.version }}\\\"" \
            --output-dir build \
            "${{ steps.meta.outputs.sketch_dir }}"

          APP_BIN="$(find build -maxdepth 1 -type f -name '*.bin' | grep -Ev '(bootloader|partitions)' | head -n 1 || true)"
          if [[ -z "${APP_BIN}" ]]; then
            echo "No application .bin found in build output" >&2
            exit 1
          fi

          ASSET_PATH="build/${{ steps.meta.outputs.asset_name }}"
          cp "${APP_BIN}" "${ASSET_PATH}"
          SHA256="$(sha256sum "${ASSET_PATH}" | awk '{print $1}')"

          echo "firmware_path=${ASSET_PATH}" >> "${GITHUB_OUTPUT}"
          echo "sha256=${SHA256}" >> "${GITHUB_OUTPUT}"

      - name: Create GitHub Release and upload .bin
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ env.REPO_TOKEN }}
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.tag }}
          target_commitish: ${{ github.sha }}
          files: ${{ steps.build.outputs.firmware_path }}
          generate_release_notes: true

      - name: Update manifests/dev.json and push to main
        shell: bash
        run: |
          set -euo pipefail

          git fetch origin main
          git checkout main
          git pull --ff-only origin main

          mkdir -p "$(dirname "${MANIFEST_PATH}")"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.meta.outputs.tag }}/${{ steps.meta.outputs.asset_name }}"

          jq -n \
            --arg version "${{ steps.meta.outputs.version }}" \
            --arg url "${RELEASE_URL}" \
            --arg sha256 "${{ steps.build.outputs.sha256 }}" \
            '{version: $version, url: $url, sha256: $sha256}' > "${MANIFEST_PATH}"

          git add "${MANIFEST_PATH}"
          if git diff --cached --quiet; then
            echo "No manifest changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "chore(manifest): update dev.json for ${{ steps.meta.outputs.tag }} [skip ci]"
          git push origin HEAD:main
