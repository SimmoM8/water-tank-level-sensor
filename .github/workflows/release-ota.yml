name: Release OTA Firmware

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 1.4.0 or v1.4.0)"
        required: true
        type: string
      fqbn:
        description: "Arduino FQBN"
        required: false
        default: "esp32:esp32:esp32"
        type: string
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release-ota:
    runs-on: ubuntu-latest
    env:
      REPO_TOKEN: ${{ secrets.REPO_PUSH_TOKEN != '' && secrets.REPO_PUSH_TOKEN || github.token }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ env.REPO_TOKEN }}

      - name: Resolve release metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            RAW_VERSION="${{ inputs.version }}"
            FQBN="${{ inputs.fqbn }}"
          else
            RAW_VERSION="${GITHUB_REF_NAME}"
            FQBN="esp32:esp32:esp32"
          fi

          VERSION="${RAW_VERSION#v}"
          TAG="v${VERSION}"

          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "tag=${TAG}" >> "${GITHUB_OUTPUT}"
          echo "fqbn=${FQBN}" >> "${GITHUB_OUTPUT}"

      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      - name: Install ESP32 core
        shell: bash
        run: |
          set -euo pipefail
          arduino-cli core update-index
          arduino-cli core install esp32:esp32

      - name: Compile firmware
        id: build
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p build
          arduino-cli compile \
            --fqbn "${{ steps.meta.outputs.fqbn }}" \
            --build-property "compiler.cpp.extra_flags=-DFW_VERSION=\\\"${{ steps.meta.outputs.version }}\\\"" \
            --output-dir build \
            esp32/level_sensor

          APP_BIN="$(find build -maxdepth 1 -type f -name '*.bin' | grep -Ev '(bootloader|partitions)' | head -n 1 || true)"
          if [[ -z "${APP_BIN}" ]]; then
            echo "No application .bin found in build output" >&2
            exit 1
          fi

          cp "${APP_BIN}" build/firmware.bin
          SHA256="$(sha256sum build/firmware.bin | awk '{print $1}')"

          echo "firmware_path=build/firmware.bin" >> "${GITHUB_OUTPUT}"
          echo "sha256=${SHA256}" >> "${GITHUB_OUTPUT}"

      - name: Create GitHub Release and upload .bin
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ env.REPO_TOKEN }}
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.tag }}
          target_commitish: ${{ github.sha }}
          files: ${{ steps.build.outputs.firmware_path }}
          generate_release_notes: true

      - name: Update manifests/dev.json and push to main
        shell: bash
        run: |
          set -euo pipefail

          git fetch origin main
          git checkout main
          git pull --ff-only origin main

          mkdir -p manifests
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.meta.outputs.tag }}/firmware.bin"

          jq -n \
            --arg version "${{ steps.meta.outputs.version }}" \
            --arg url "${RELEASE_URL}" \
            --arg sha256 "${{ steps.build.outputs.sha256 }}" \
            '{version: $version, url: $url, sha256: $sha256}' > manifests/dev.json

          git add manifests/dev.json
          if git diff --cached --quiet; then
            echo "No manifest changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "chore(manifest): update dev.json for ${{ steps.meta.outputs.tag }} [skip ci]"
          git push origin HEAD:main
